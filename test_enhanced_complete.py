#!/usr/bin/env python3
"""
Comprehensive Test Script for Enhanced Biomedical Data Extraction System

This script tests all the enhanced components from the root directory.
"""

import sys
import os
import asyncio
from pathlib import Path

# Add src to path
sys.path.insert(0, str(Path(__file__).parent / "src"))

def test_core_components():
    """Test core components."""
    print("üß™ Testing Core Components...")
    
    try:
        from core.base import ProcessingResult, PatientRecord
        print("‚úÖ Core base classes imported")
        
        from core.feedback_loop import FeedbackLoop
        print("‚úÖ Feedback loop imported")
        
        from core.prompt_optimization import PromptOptimizer
        print("‚úÖ Prompt optimizer imported")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Core components test failed: {e}")
        return False

def test_llm_clients():
    """Test LLM clients."""
    print("\nüß™ Testing LLM Clients...")
    
    try:
        from core.llm_client.openrouter_client import OpenRouterClient
        print("‚úÖ OpenRouter client imported")
        
        from core.llm_client.huggingface_client import HuggingFaceClient, HuggingFaceModelManager
        print("‚úÖ HuggingFace client imported")
        
        return True
        
    except Exception as e:
        print(f"‚ùå LLM clients test failed: {e}")
        return False

def test_rag_system():
    """Test RAG system."""
    print("\nüß™ Testing RAG System...")
    
    try:
        from rag.rag_integration import RAGIntegration, create_example_from_success
        
        # Initialize RAG system
        rag = RAGIntegration()
        print("‚úÖ RAG system initialized")
        
        # Test adding an example
        example = create_example_from_success(
            text="Patient has seizures and developmental delay",
            extracted_data={"phenotypes": ["seizures", "developmental delay"]},
            field_type="phenotypes",
            confidence=0.8
        )
        
        rag.add_example(example)
        print("‚úÖ Example added to RAG system")
        
        # Test context retrieval
        context = rag.get_context("Patient with seizures", field_type="phenotypes")
        print(f"‚úÖ Context retrieved: {context.total_retrieved} items")
        
        return True
        
    except Exception as e:
        print(f"‚ùå RAG system test failed: {e}")
        return False

def test_feedback_system():
    """Test feedback loop system."""
    print("\nüß™ Testing Feedback System...")
    
    try:
        from core.feedback_loop import FeedbackLoop
        
        # Initialize feedback system
        feedback = FeedbackLoop()
        print("‚úÖ Feedback system initialized")
        
        # Test with sample data
        predictions = [
            {"phenotypes": ["seizures"], "age": 5},
            {"phenotypes": ["developmental delay"], "age": 3}
        ]
        
        ground_truth = [
            {"phenotypes": ["seizures", "developmental delay"], "age": 5},
            {"phenotypes": ["developmental delay"], "age": 3}
        ]
        
        result = feedback.compare_predictions(predictions, ground_truth, "test_model")
        print(f"‚úÖ Feedback analysis completed: {result.overall_accuracy:.2%} accuracy")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Feedback system test failed: {e}")
        return False

def test_prompt_optimizer():
    """Test prompt optimization system."""
    print("\nüß™ Testing Prompt Optimizer...")
    
    try:
        from core.prompt_optimization import PromptOptimizer
        
        # Initialize prompt optimizer
        optimizer = PromptOptimizer()
        print("‚úÖ Prompt optimizer initialized")
        
        # Test getting best prompt
        prompt = optimizer.get_best_prompt("demographics", "age")
        if prompt:
            print(f"‚úÖ Best prompt retrieved: {prompt.prompt_id}")
        else:
            print("‚ö†Ô∏è  No prompts available")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Prompt optimizer test failed: {e}")
        return False

def test_ontologies():
    """Test ontology managers."""
    print("\nüß™ Testing Ontology Managers...")
    
    try:
        # Test HPO manager
        try:
            from ontologies.hpo_manager import HPOManager
            hpo_manager = HPOManager()
            print("‚úÖ Standard HPO manager initialized")
        except Exception as e:
            print(f"‚ö†Ô∏è  Standard HPO manager failed: {e}")
        
        # Test optimized HPO manager
        try:
            hpo_path = "data/ontologies/hp.json"
            if os.path.exists(hpo_path):
                from ontologies.hpo_manager_optimized import OptimizedHPOManager
                hpo_manager = OptimizedHPOManager(hpo_path)
                print("‚úÖ Optimized HPO manager initialized")
                
                # Test search
                matches = hpo_manager.search_terms("seizures", max_results=3)
                print(f"‚úÖ HPO search working: {len(matches)} matches found")
            else:
                print("‚ö†Ô∏è  hp.json not found, skipping optimized HPO manager")
        except Exception as e:
            print(f"‚ö†Ô∏è  Optimized HPO manager failed: {e}")
        
        # Test gene manager
        try:
            from ontologies.gene_manager import GeneManager
            gene_manager = GeneManager()
            print("‚úÖ Gene manager initialized")
        except Exception as e:
            print(f"‚ö†Ô∏è  Gene manager failed: {e}")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Ontology managers test failed: {e}")
        return False

def test_extraction_agents():
    """Test extraction agents."""
    print("\nüß™ Testing Extraction Agents...")
    
    try:
        # Test demographics agent
        try:
            from agents.extraction_agents.demographics_agent import DemographicsAgent
            print("‚úÖ Demographics agent imported")
        except Exception as e:
            print(f"‚ö†Ô∏è  Demographics agent failed: {e}")
        
        # Test genetics agent
        try:
            from agents.extraction_agents.genetics_agent import GeneticsAgent
            print("‚úÖ Genetics agent imported")
        except Exception as e:
            print(f"‚ö†Ô∏è  Genetics agent failed: {e}")
        
        # Test treatments agent
        try:
            from agents.extraction_agents.treatments_agent import TreatmentsAgent
            print("‚úÖ Treatments agent imported")
        except Exception as e:
            print(f"‚ö†Ô∏è  Treatments agent failed: {e}")
        
        # Test simple phenotypes agent
        try:
            from agents.extraction_agents.phenotypes_agent_simple import SimplePhenotypesAgent
            print("‚úÖ Simple phenotypes agent imported")
        except Exception as e:
            print(f"‚ö†Ô∏è  Simple phenotypes agent failed: {e}")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Extraction agents test failed: {e}")
        return False

def test_processors():
    """Test document processors."""
    print("\nüß™ Testing Document Processors...")
    
    try:
        from processors.pdf_parser import PDFParser
        print("‚úÖ PDF parser imported")
        
        from processors.patient_segmenter import PatientSegmenter
        print("‚úÖ Patient segmenter imported")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Document processors test failed: {e}")
        return False

def test_database():
    """Test database managers."""
    print("\nüß™ Testing Database Managers...")
    
    try:
        from database.sqlite_manager import SQLiteManager
        print("‚úÖ SQLite manager imported")
        
        from database.vector_manager import VectorManager
        print("‚úÖ Vector manager imported")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Database managers test failed: {e}")
        return False

def test_ollama_integration():
    """Test Ollama integration."""
    print("\nüß™ Testing Ollama Integration...")
    
    try:
        import subprocess
        
        # Check if ollama is available
        result = subprocess.run(['ollama', 'list'], capture_output=True, text=True)
        if result.returncode == 0:
            print("‚úÖ Ollama is available")
            
            # Check for llama3.1:8b model
            if 'llama3.1:8b' in result.stdout:
                print("‚úÖ llama3.1:8b model is available")
                
                # Test simple generation
                test_result = subprocess.run(
                    ['ollama', 'run', 'llama3.1:8b', 'Hello, how are you?'],
                    capture_output=True, text=True, timeout=30
                )
                
                if test_result.returncode == 0:
                    print("‚úÖ Ollama generation test passed")
                    return True
                else:
                    print("‚ö†Ô∏è  Ollama generation test failed")
                    return False
            else:
                print("‚ö†Ô∏è  llama3.1:8b model not found")
                return False
        else:
            print("‚ùå Ollama not available")
            return False
            
    except Exception as e:
        print(f"‚ùå Ollama integration test failed: {e}")
        return False

def test_enhanced_orchestrator():
    """Test enhanced orchestrator."""
    print("\nüß™ Testing Enhanced Orchestrator...")
    
    try:
        # Test simplified orchestrator first
        from agents.orchestrator.enhanced_orchestrator_simple import SimpleEnhancedOrchestrator
        
        orchestrator = SimpleEnhancedOrchestrator()
        print("‚úÖ Simple enhanced orchestrator created")
        
        # Get system status
        status = orchestrator.get_system_status()
        print(f"‚úÖ System status: {status.system_health}")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Enhanced orchestrator test failed: {e}")
        return False

def main():
    """Run all tests."""
    print("üöÄ Enhanced Biomedical Data Extraction System - Comprehensive Tests")
    print("=" * 80)
    
    tests = [
        test_core_components,
        test_llm_clients,
        test_rag_system,
        test_feedback_system,
        test_prompt_optimizer,
        test_ontologies,
        test_extraction_agents,
        test_processors,
        test_database,
        test_ollama_integration,
        test_enhanced_orchestrator
    ]
    
    passed = 0
    total = len(tests)
    
    for test in tests:
        try:
            if test():
                passed += 1
        except Exception as e:
            print(f"‚ùå Test {test.__name__} crashed: {e}")
    
    print("\n" + "=" * 80)
    print(f"üìä Test Results: {passed}/{total} tests passed")
    
    if passed == total:
        print("üéâ All tests passed! Enhanced system is fully operational.")
    elif passed >= total * 0.8:
        print("‚úÖ Most tests passed! System is mostly operational.")
    elif passed >= total * 0.6:
        print("‚ö†Ô∏è  Many tests passed. System has some issues but is usable.")
    else:
        print("üö® Many tests failed. System needs significant fixes.")
    
    print("\nüîß Next Steps:")
    if passed == total:
        print("‚Ä¢ Run extraction: python src/agents/orchestrator/enhanced_orchestrator_simple.py extract --input data/input/PMID32679198.pdf --output results.json")
        print("‚Ä¢ Check system status: python src/agents/orchestrator/enhanced_orchestrator_simple.py status")
    else:
        print("‚Ä¢ Fix failed component imports")
        print("‚Ä¢ Check Python path and module structure")
        print("‚Ä¢ Verify all dependencies are installed")
    
    return passed >= total * 0.6  # Consider success if 60% or more tests pass

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
